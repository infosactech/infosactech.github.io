---
title: V12.2.1 File Integrity
---



## Requirement:

Verify that files obtained from untrusted sources are validated to be of expected type based on the file's content.

## Explanation:

Требование определяет необходимость проверки соответствия содержимого файлов их ожидаемому типу на основе их реального содержимого. Данное требование направлено на предотвращение атак, в ходе которых злоумышленники пытаются загрузить или предоставить файлы с недостоверным или вредоносным содержимым, искажая расширение или тип файла.

1 
**Expected File Type Validation:**

  - Вместо того чтобы полагаться исключительно на расширения файлов или метаданные, предоставляемые пользователями или недоверенными источниками, данное требование предполагает проверку фактического содержимого файлов для определения их типа. Такая проверка гарантирует, что содержимое файла соответствует его ожидаемому типу.
1 
**Protecting Against Malicious Uploads:**

  - Злоумышленники могут попытаться загрузить файлы с вредоносным содержимым, изменив расширение файла или используя вводящие в заблуждение метаданные. Проверяя содержимое, приложение может предотвратить загрузку файлов, не соответствующих ожидаемому типу.
1 
**Preventing Content-Type Manipulation:**

  - Злоумышленники могут манипулировать заголовком "Content-Type" HTTP-запроса, чтобы заставить сервер интерпретировать содержимое по-другому. Валидация заголовка Content-Type недостаточна, поскольку его можно подделать. Более надежной является проверка самого содержимого..
1 
**Mitigating Threats like File Inclusion Attacks:**

  -  Убедиться в том, что включаемые файлы, например, используемые в атаках на включение файлов, имеют ожидаемый тип, позволяет предотвратить уязвимости, которые могут возникнуть в результате предоставления пользователям нежелательного содержимого или выполнения вредоносного кода.
1 
**Defending Against Malware and Exploits:**

  - Проверяя целостность содержимого файлов, приложение может обнаружить и предотвратить загрузку файлов, содержащих вредоносное ПО, вирусы или вредоносный код, который может использовать уязвимости.


## Remediation:

Чтобы привести приложение в соответствие требованию о целостности файлов и обеспечить проверку файлов, полученных из недоверенных источников, на принадлежность к ожидаемому типу на основе их содержимого, выполните следующие действия:

1 
**Implement Content-Based Validation:**

  - Вместо того чтобы полагаться только на расширения файлов или метаданные, внедрите механизмы проверки на основе содержимого, которые анализируют фактическое содержимое файлов для определения их типа.
1 
**Use Content Validation Libraries:**

  - Используйте библиотеки или инструменты, позволяющие определять тип содержимого на основе его структуры и данных. Например, библиотека mimetypes в Python позволяет сопоставить расширения файлов с ожидаемыми типами, а сторонние библиотеки, такие как python-magic, анализируют сигнатуры файлов.
1 
**Implement Secure Upload Mechanism:**

  - Внесите изменения в механизм загрузки файлов, чтобы обеспечить проверку на основе содержимого. Отклоняйте файлы, не соответствующие ожидаемому типу, даже если расширение указывает на обратное.
1 
**Prevent Content Spoofing:**

  - Отслеживайте запросы, содержащие измененные или противоречивые заголовки "Content-Type". Следует рассматривать заголовки "Content-Type" как тиггер для проверки содержимого, а также для точного определения типа.


Пример кода, демонстрирующего реализацию проверки типов файлов на основе содержимого с использованием библиотеки magic в :


```
import magic

class InvalidFileTypeException(Exception):
    pass

def verify_file_type(file_path):
    mime_type = magic.from_file(file_path, mime=True)
    file_extension = file_path.split('.')[-1].lower()  # Extract the file extension

    expected_types = {
        "text/plain": ["txt"],
        "image/jpeg": ["jpg", "jpeg"],
        "image/png": ["png"],
        "audio/mpeg": ["mp3"],
        # Add other expected types as needed
    }

    for expected_type, extensions in expected_types.items():
        if mime_type == expected_type and file_extension in extensions:
            return True

    raise InvalidFileTypeException("Unexpected file type: {}".format(mime_type))

# Usage example
try:
    file_path = "sample.jpg"
    verify_file_type(file_path)
    print("File type verification successful.")
except InvalidFileTypeException as e:
    print(e)
 
```


Этот код использует библиотеку magic для определения типа MIME данного файла. Затем он сравнивает тип MIME с набором ожидаемых типов, которые указаны в словаре с типом MIME в качестве ключа и списком расширений файлов в качестве значения. Если MIME-тип файла соответствует одному из ожидаемых типов, функция возвращает значение True, указывая на то, что файл имеет ожидаемый тип. Если тип MIME не соответствует ни одному из ожидаемых типов, возникает исключение, указывающее, что файл имеет непредвиденный тип.

## Additional:

[https://cwe.mitre.org/data/definitions/434.html](https://cwe.mitre.org/data/definitions/434.html)













